{% extends "base.html" %}

{% block title %}ðŸ§  Explainable AI - ExoplanetML{% endblock %}

{% block content %}
<div class="container-fluid py-5 mt-5">
    <!-- Explainability Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-info">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-brain me-2"></i>
                        Explainable AI System
                    </h4>
                    <p class="mb-0 mt-2">Advanced model interpretability using SHAP, LIME, and feature importance analysis</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Explainability Interface -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card bg-dark border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-search me-2"></i>
                        Model Explanation Input
                    </h5>
                </div>
                <div class="card-body">
                    <form id="explainabilityForm">
                        <div class="mb-3">
                            <label for="expPeriod" class="form-label">
                                <i class="fas fa-clock me-1"></i>Orbital Period (days)
                            </label>
                            <input type="number" class="form-control" id="expPeriod" 
                                   value="365" min="0.1" max="10000" step="0.1">
                        </div>

                        <div class="mb-3">
                            <label for="expRadius" class="form-label">
                                <i class="fas fa-globe me-1"></i>Planet Radius (Earth radii)
                            </label>
                            <input type="number" class="form-control" id="expRadius" 
                                   value="1.0" min="0.1" max="50" step="0.1">
                        </div>

                        <div class="mb-3">
                            <label for="expStellarTemp" class="form-label">
                                <i class="fas fa-sun me-1"></i>Stellar Temperature (K)
                            </label>
                            <input type="number" class="form-control" id="expStellarTemp" 
                                   value="5800" min="2000" max="10000" step="100">
                        </div>

                        <div class="mb-3">
                            <label for="expStellarRadius" class="form-label">
                                <i class="fas fa-circle me-1"></i>Stellar Radius (Solar radii)
                            </label>
                            <input type="number" class="form-control" id="expStellarRadius" 
                                   value="1.0" min="0.1" max="100" step="0.1">
                        </div>

                        <div class="mb-3">
                            <label for="expDepth" class="form-label">
                                <i class="fas fa-chart-line me-1"></i>Transit Depth
                            </label>
                            <input type="number" class="form-control" id="expDepth" 
                                   value="0.01" min="0.001" max="1" step="0.001">
                        </div>

                        <div class="mb-3">
                            <label for="explanationType" class="form-label">
                                <i class="fas fa-cogs me-1"></i>Explanation Type
                            </label>
                            <select class="form-select" id="explanationType">
                                <option value="shap">SHAP Values</option>
                                <option value="lime">LIME Explanations</option>
                                <option value="both">Both SHAP & LIME</option>
                            </select>
                        </div>

                        <!-- Quick Samples -->
                        <div class="mb-3">
                            <div class="btn-group w-100" role="group" aria-label="Quick samples">
                                <button type="button" class="btn btn-success" onclick="loadExplainabilitySample('confirmed')">
                                    <i class="fas fa-check me-1"></i>Confirmed
                                </button>
                                <button type="button" class="btn btn-warning" onclick="loadExplainabilitySample('candidate')">
                                    <i class="fas fa-question me-1"></i>Candidate
                                </button>
                                <button type="button" class="btn btn-danger" onclick="loadExplainabilitySample('false_positive')">
                                    <i class="fas fa-times me-1"></i>False Positive
                                </button>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-info btn-lg">
                                <i class="fas fa-brain me-2"></i>Generate Explanation
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <!-- Explanation Results -->
            <div id="explanationResults" class="card bg-dark border-info" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Model Explanation Results
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-info" id="explanationPrediction">-</h4>
                                <p class="mb-0">Prediction</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-success" id="explanationConfidence">-</h4>
                                <p class="mb-0">Confidence</p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-primary">Feature Importance</h6>
                            <div id="featureImportanceList" class="p-3 rounded" style="background:#ffffff; color:#111827; border:1px solid #e5e7eb;">
                                <!-- Feature importance will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3D Exoplanet Visualization -->
            <div id="viz3dCard" class="card bg-dark border-secondary mt-3">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-globe me-2"></i>
                        3D Exoplanet Visualization
                    </h5>
                </div>
                <div class="card-body">
                    <div id="threeContainer" style="width: 100%; height: 360px; background: #000; border-radius: 8px;"></div>
                    <small class="text-muted d-block mt-2">Drag to orbit, scroll to zoom. Star/planet scale, color, and orbit reflect your inputs.</small>
                </div>
            </div>

            <!-- Explanation Methods -->
            <div class="card bg-dark border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Explanation Methods
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <h6 class="text-primary">SHAP Values</h6>
                            <ul class="list-unstyled small text-muted">
                                <li>â€¢ Global feature importance</li>
                                <li>â€¢ Local explanations</li>
                                <li>â€¢ Model-agnostic</li>
                                <li>â€¢ Additive feature attributions</li>
                            </ul>
                        </div>
                        <div class="col-6">
                            <h6 class="text-primary">LIME</h6>
                            <ul class="list-unstyled small text-muted">
                                <li>â€¢ Local interpretable explanations</li>
                                <li>â€¢ Linear approximations</li>
                                <li>â€¢ Perturbation-based</li>
                                <li>â€¢ Human-readable</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Explanation Visualization (removed by request) -->

    <!-- Model Interpretability -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-eye me-2"></i>
                        Model Interpretability
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="text-primary">Global Interpretability</h6>
                            <p class="text-muted small">
                                Understanding how the model makes decisions across all inputs. 
                                Shows which features are most important overall.
                            </p>
                            <ul class="list-unstyled small text-muted">
                                <li>â€¢ Feature importance rankings</li>
                                <li>â€¢ Model behavior patterns</li>
                                <li>â€¢ Bias detection</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-primary">Local Interpretability</h6>
                            <p class="text-muted small">
                                Understanding why the model made a specific prediction for 
                                a particular input. Explains individual decisions.
                            </p>
                            <ul class="list-unstyled small text-muted">
                                <li>â€¢ Individual predictions</li>
                                <li>â€¢ Feature contributions</li>
                                <li>â€¢ Decision rationale</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-primary">Counterfactual Analysis</h6>
                            <p class="text-muted small">
                                Understanding what changes to inputs would lead to 
                                different predictions. "What if" scenarios.
                            </p>
                            <ul class="list-unstyled small text-muted">
                                <li>â€¢ Sensitivity analysis</li>
                                <li>â€¢ Alternative scenarios</li>
                                <li>â€¢ Decision boundaries</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Explanation Examples -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Explanation Examples
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>Scenario</th>
                                    <th>Prediction</th>
                                    <th>Key Features</th>
                                    <th>Explanation</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Earth-like Planet</strong></td>
                                    <td><span class="badge bg-success">Confirmed</span></td>
                                    <td>Radius: 1.0, Period: 365 days</td>
                                    <td>Size and orbital period within habitable range</td>
                                    <td>89%</td>
                                </tr>
                                <tr>
                                    <td><strong>Gas Giant</strong></td>
                                    <td><span class="badge bg-warning">Candidate</span></td>
                                    <td>Radius: 12.0, Depth: 0.15</td>
                                    <td>Large radius suggests gas giant, deep transit</td>
                                    <td>72%</td>
                                </tr>
                                <tr>
                                    <td><strong>False Positive</strong></td>
                                    <td><span class="badge bg-danger">False Positive</span></td>
                                    <td>SNR: 3.2, Duration: 0.02</td>
                                    <td>Low signal-to-noise ratio, short duration</td>
                                    <td>85%</td>
                                </tr>
                                <tr>
                                    <td><strong>Hot Jupiter</strong></td>
                                    <td><span class="badge bg-success">Confirmed</span></td>
                                    <td>Period: 3.2 days, Radius: 8.5</td>
                                    <td>Short period, large radius typical of hot Jupiter</td>
                                    <td>94%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Three.js for 3D visualization -->
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
<script>
document.getElementById('explainabilityForm').addEventListener('submit', function(e) {
    e.preventDefault();
    generateExplanation();
});

function loadExplainabilitySample(type) {
    const samples = {
        confirmed: {
            expPeriod: 365,
            expRadius: 1.0,
            expStellarTemp: 5800,
            expStellarRadius: 1.0,
            expDepth: 0.01
        },
        candidate: {
            expPeriod: 15.0,
            expRadius: 2.0,
            expStellarTemp: 5800,
            expStellarRadius: 1.0,
            expDepth: 0.002
        },
        false_positive: {
            expPeriod: 0.8,
            expRadius: 0.3,
            expStellarTemp: 8000,
            expStellarRadius: 1.8,
            expDepth: 0.35
        }
    };
    const s = samples[type];
    if (!s) return;
    document.getElementById('expPeriod').value = s.expPeriod;
    document.getElementById('expRadius').value = s.expRadius;
    document.getElementById('expStellarTemp').value = s.expStellarTemp;
    document.getElementById('expStellarRadius').value = s.expStellarRadius;
    document.getElementById('expDepth').value = s.expDepth;
    // Auto-run explanation for faster UX
    generateExplanation();
}

function generateExplanation() {
    // Update the 3D scene first for immediate feedback
    try { update3DFromForm(); } catch (e) { console.warn('3D update error (pre-fetch):', e); }

    const formData = {
        period: parseFloat(document.getElementById('expPeriod').value),
        planet_radius: parseFloat(document.getElementById('expRadius').value),
        stellar_temp: parseFloat(document.getElementById('expStellarTemp').value),
        stellar_radius: parseFloat(document.getElementById('expStellarRadius').value),
        transit_depth: parseFloat(document.getElementById('expDepth').value),
        explanation_type: document.getElementById('explanationType').value
    };

    fetch('/api/explainability', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        displayExplanationResults(data);
        try { update3DFromForm(); } catch (e) { console.warn('3D update error (post-fetch):', e); }
    })
    .catch(error => {
        console.error('Error generating explanation:', error);
        // Use mock data for demonstration
        displayExplanationResults(getMockExplanationData(formData));
        try { update3DFromForm(); } catch (e) { console.warn('3D update error (fallback):', e); }
    });
}

function displayExplanationResults(explanation) {
    document.getElementById('explanationResults').style.display = 'block';
    
    // Update prediction and confidence
    document.getElementById('explanationPrediction').textContent = explanation.prediction || 'confirmed';
    document.getElementById('explanationConfidence').textContent = 
        ((explanation.confidence || 0.85) * 100).toFixed(1) + '%';
    
    // Update feature importance
    updateFeatureImportance(explanation.feature_importance || {});
    
    // Update visualizations
    updateFeatureImportanceChart(explanation.feature_importance || {});
    updateSHAPChart(explanation.shap_values || {});
    updateLIMEChart(explanation.lime_values || {});
    
    // Update summary
    updateExplanationSummary(explanation);
}

function updateFeatureImportance(featureImportance) {
    const importanceList = document.getElementById('featureImportanceList');
    let html = '';
    
    const features = Object.entries(featureImportance)
        .sort(([,a], [,b]) => Math.abs(b) - Math.abs(a))
        .slice(0, 5);
    
    features.forEach(([feature, importance]) => {
        const importanceClass = importance > 0 ? 'text-success' : 'text-danger';
        const icon = importance > 0 ? 'fa-arrow-up' : 'fa-arrow-down';
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span><i class="fas ${icon} me-2"></i>${feature.replace('_', ' ').toUpperCase()}</span>
                <span class="${importanceClass}">${importance.toFixed(3)}</span>
            </div>
        `;
    });
    
    importanceList.innerHTML = html;
}

function updateFeatureImportanceChart(featureImportance) {
    const ctx = document.getElementById('featureImportanceChart').getContext('2d');
    
    if (window.featureImportanceChart) {
        window.featureImportanceChart.destroy();
    }
    
    const features = Object.keys(featureImportance);
    const values = Object.values(featureImportance);
    
    window.featureImportanceChart = new Chart(ctx, {
        type: 'horizontalBar',
        data: {
            labels: features.map(f => f.replace('_', ' ').toUpperCase()),
            datasets: [{
                label: 'Feature Importance',
                data: values,
                backgroundColor: values.map(v => v > 0 ? '#28a745' : '#dc3545'),
                borderWidth: 1,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: {
                    ticks: {
                        color: '#ffffff'
                    }
                },
                y: {
                    ticks: {
                        color: '#ffffff'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateSHAPChart(shapValues) {
    const ctx = document.getElementById('shapChart').getContext('2d');
    
    if (window.shapChart) {
        window.shapChart.destroy();
    }
    
    // Mock SHAP values if not provided
    const features = ['Planet Radius', 'Stellar Temp', 'Orbital Period', 'Transit Depth', 'Stellar Radius'];
    const values = shapValues.values || [0.25, 0.20, 0.18, 0.15, 0.12];
    
    window.shapChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: features,
            datasets: [{
                label: 'SHAP Values',
                data: values,
                backgroundColor: '#17a2b8',
                borderWidth: 1,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    ticks: {
                        color: '#ffffff'
                    }
                },
                x: {
                    ticks: {
                        color: '#ffffff'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateLIMEChart(limeValues) {
    const ctx = document.getElementById('limeChart').getContext('2d');
    
    if (window.limeChart) {
        window.limeChart.destroy();
    }
    
    // Mock LIME values if not provided
    const features = ['Planet Radius', 'Stellar Temp', 'Orbital Period', 'Transit Depth', 'Stellar Radius'];
    const values = limeValues.values || [0.22, 0.18, 0.16, 0.14, 0.10];
    
    window.limeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: features,
            datasets: [{
                label: 'LIME Values',
                data: values,
                backgroundColor: '#ffc107',
                borderWidth: 1,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    ticks: {
                        color: '#ffffff'
                    }
                },
                x: {
                    ticks: {
                        color: '#ffffff'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateExplanationSummary(explanation) {
    const featureImportance = explanation.feature_importance || {};
    const topFeature = Object.entries(featureImportance)
        .sort(([,a], [,b]) => Math.abs(b) - Math.abs(a))[0];
    
    document.getElementById('topFeature').textContent = topFeature ? topFeature[0].replace('_', ' ') : 'N/A';
    document.getElementById('topContribution').textContent = topFeature ? topFeature[1].toFixed(3) : 'N/A';
    document.getElementById('modelUsed').textContent = explanation.model_used || 'XGBoost';
    document.getElementById('expType').textContent = document.getElementById('explanationType').value.toUpperCase();
}

function getMockExplanationData(formData) {
    // Generate mock explanation data
    const features = {
        'planet_radius': formData.planet_radius,
        'stellar_temp': formData.stellar_temp,
        'period': formData.period,
        'transit_depth': formData.transit_depth,
        'stellar_radius': formData.stellar_radius
    };
    
    // Calculate mock feature importance based on input values
    const featureImportance = {};
    Object.entries(features).forEach(([key, value]) => {
        // Simple heuristic for feature importance
        let importance = 0;
        if (key === 'planet_radius') {
            importance = Math.abs(value - 1.0) * 0.5; // Closer to Earth size = higher importance
        } else if (key === 'stellar_temp') {
            importance = Math.abs(value - 5800) / 1000 * 0.3; // Closer to Sun temp = higher importance
        } else if (key === 'period') {
            importance = Math.abs(value - 365.25) / 365.25 * 0.2; // Closer to Earth period = higher importance
        } else if (key === 'transit_depth') {
            importance = value * 10; // Deeper transit = higher importance
        } else if (key === 'stellar_radius') {
            importance = Math.abs(value - 1.0) * 0.4; // Closer to Sun radius = higher importance
        }
        
        featureImportance[key] = importance;
    });
    
    // Normalize importance values
    const maxImportance = Math.max(...Object.values(featureImportance));
    Object.keys(featureImportance).forEach(key => {
        featureImportance[key] = featureImportance[key] / maxImportance;
    });
    
    return {
        prediction: 'confirmed',
        confidence: 0.85,
        feature_importance: featureImportance,
        shap_values: {
            values: Object.values(featureImportance)
        },
        lime_values: {
            values: Object.values(featureImportance).map(v => v * 0.9) // Slightly different for comparison
        },
        model_used: 'XGBoost'
    };
}

// ============================
// 3D Visualization (Three.js)
// ============================
let scene, camera, renderer, controls;
let starMesh, planetMesh, orbitMesh;
let orbitAngle = 0;
let orbitSpeed = 0.01;
let isAnimating = false;
let resizeRaf = null;
let currentOrbitRadius = 6; // stable default

function init3D() {
    const container = document.getElementById('threeContainer');
    if (!container) return;
    if (typeof THREE === 'undefined') {
        container.innerHTML = '<div style="color:#fff; padding:12px; text-align:center;">3D failed to load: Three.js not available.</div>';
        return;
    }
    if (renderer) {
        // Already initialized; ensure size is correct and skip re-init
        onWindowResize();
        return;
    }
    // Scene
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    // Camera
    const aspect = container.clientWidth / Math.max(container.clientHeight, 1);
    camera = new THREE.PerspectiveCamera(60, aspect, 0.1, 1000);
    camera.position.set(0, 0, 12);
    // Renderer
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false, powerPreference: 'high-performance' });
    const width = Math.max(container.clientWidth, 1);
    const height = Math.max(container.clientHeight, 1);
    renderer.setSize(width, height);
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    if (renderer.outputColorSpace !== undefined) {
        renderer.outputColorSpace = THREE.SRGBColorSpace;
    }
    renderer.toneMappingExposure = 1.1;
    renderer.setClearColor(0x111111, 1);
    container.innerHTML = '';
    container.appendChild(renderer.domElement);
    // Controls (with fallback if OrbitControls unavailable)
    if (THREE.OrbitControls) {
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 2;
        controls.maxDistance = 100;
        controls.autoRotate = true; // gentle motion without zoom drift
        controls.autoRotateSpeed = 0.5;
    } else {
        console.warn('OrbitControls not available; enabling auto-rotate fallback');
        controls = null;
    }
    // Lights
    const ambient = new THREE.AmbientLight(0x404040, 0.9);
    scene.add(ambient);
    const point = new THREE.PointLight(0xffffff, 3.0, 0, 2);
    point.position.set(0, 0, 0);
    scene.add(point);
    // Star (placeholder)
    starMesh = new THREE.Mesh(
        new THREE.SphereGeometry(1, 32, 32),
        new THREE.MeshBasicMaterial({ color: 0xffdd66 })
    );
    scene.add(starMesh);
    // Planet (placeholder)
    planetMesh = new THREE.Mesh(
        new THREE.SphereGeometry(0.4, 32, 32),
        new THREE.MeshBasicMaterial({ color: 0x66ccff })
    );
    planetMesh.position.set(currentOrbitRadius, 0, 0);
    scene.add(planetMesh);
    // Orbit path
    orbitMesh = new THREE.LineLoop(
        new THREE.BufferGeometry(),
        new THREE.LineBasicMaterial({ color: 0x555555 })
    );
    scene.add(orbitMesh);
    // Helpers for visibility
    try {
        const axes = new THREE.AxesHelper(2);
        axes.material.depthTest = false;
        axes.renderOrder = 1;
        scene.add(axes);
        const grid = new THREE.GridHelper(50, 50, 0x444444, 0x222222);
        grid.position.y = -2;
        scene.add(grid);
    } catch (e) { /* ignore */ }
    // Starfield background for contrast
    try {
        const starGeo = new THREE.BufferGeometry();
        const starCount = 1000;
        const positions = new Float32Array(starCount * 3);
        for (let i = 0; i < starCount; i++) {
            const r = 100 * Math.cbrt(Math.random());
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2 * Math.random() - 1);
            positions[i * 3 + 0] = r * Math.sin(phi) * Math.cos(theta);
            positions[i * 3 + 1] = r * Math.sin(phi) * Math.sin(theta);
            positions[i * 3 + 2] = r * Math.cos(phi);
        }
        starGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        const starMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.5, sizeAttenuation: true });
        const stars = new THREE.Points(starGeo, starMat);
        stars.renderOrder = -1;
        scene.add(stars);
    } catch (e) { /* ignore */ }

    // Ensure camera looks at the system center
    if (controls) { controls.target.set(0, 0, 0); controls.update(); }
    camera.lookAt(0, 0, 0);
    // Draw an immediate first frame
    if (renderer && scene && camera) { renderer.render(scene, camera); }

    // Resize handling (debounced)
    window.addEventListener('resize', () => {
        if (resizeRaf) cancelAnimationFrame(resizeRaf);
        resizeRaf = requestAnimationFrame(onWindowResize);
    });
    if ('ResizeObserver' in window) {
        try {
            const ro = new ResizeObserver(() => {
                if (resizeRaf) cancelAnimationFrame(resizeRaf);
                resizeRaf = requestAnimationFrame(onWindowResize);
            });
            ro.observe(container);
        } catch (e) {
            console.warn('ResizeObserver unavailable:', e);
        }
    }
    if (!isAnimating) { isAnimating = true; animate(); }
    camera.lookAt(0, 0, 0);
}

function onWindowResize() {
    const container = document.getElementById('threeContainer');
    if (!container || !renderer || !camera) return;
    const width = Math.max(container.clientWidth, 1);
    const height = Math.max(container.clientHeight, 1);
    camera.aspect = width / height;
    camera.updateProjectionMatrix();
    renderer.setSize(width, height);
}

function starColorFromTemp(tempK) {
    // Very rough mapping of temperature to color
    if (tempK >= 8000) return new THREE.Color(0x9bbcff); // blue-white
    if (tempK >= 6500) return new THREE.Color(0xf0f5ff); // white
    if (tempK >= 5500) return new THREE.Color(0xffe39b); // yellow
    if (tempK >= 4500) return new THREE.Color(0xffc27a); // orange
    return new THREE.Color(0xff8c5a); // red-orange
}

function update3DFromForm() {
    if (!scene || !starMesh || !planetMesh) return;
    const period = parseFloat(document.getElementById('expPeriod').value) || 365;
    const planetRadius = parseFloat(document.getElementById('expRadius').value) || 1.0; // Earth radii
    const stellarTemp = parseFloat(document.getElementById('expStellarTemp').value) || 5800; // K
    const stellarRadius = parseFloat(document.getElementById('expStellarRadius').value) || 1.0; // Solar radii
    const transitDepth = parseFloat(document.getElementById('expDepth').value) || 0.01;
    // Scale mapping (stylized for clarity)
    const starScale = Math.min(Math.max(stellarRadius, 0.2), 5.0);
    const planetScale = Math.min(Math.max(planetRadius * 0.2, 0.03), starScale * 0.8);
    starMesh.scale.set(starScale, starScale, starScale);
    planetMesh.scale.set(planetScale, planetScale, planetScale);
    // Star color/emissive from temperature
    const starColor = starColorFromTemp(stellarTemp);
    const starMat = starMesh.material;
    if (starMat && starMat.color) {
        starMat.color = starColor.clone();
        starMat.needsUpdate = true;
    }
    // Planet color slightly based on depth (deeper transit => darker albedo)
    const depthFactor = Math.min(Math.max(transitDepth, 0.0001), 0.2);
    const basePlanet = new THREE.Color(0x3399ff);
    const darkened = basePlanet.clone().multiplyScalar(1.0 - Math.min(depthFactor * 2.5, 0.7));
    planetMesh.material.color = darkened;
    planetMesh.material.metalness = 0.1 + Math.min(depthFactor * 1.5, 0.7);
    planetMesh.material.roughness = 0.7;
    planetMesh.material.needsUpdate = true;
    // Orbit radius based on log(period)
    const orbitRadius = Math.min(Math.max((Math.log10(period + 1) * 3.0) + starScale * 1.5, 2.0), 40.0);
    currentOrbitRadius = orbitRadius;
    // Update orbit path geometry
    const segments = 128;
    const positions = new Float32Array(segments * 3);
    for (let i = 0; i < segments; i++) {
        const t = (i / segments) * Math.PI * 2;
        positions[i * 3 + 0] = Math.cos(t) * orbitRadius;
        positions[i * 3 + 1] = 0;
        positions[i * 3 + 2] = Math.sin(t) * orbitRadius;
    }
    const geom = new THREE.BufferGeometry();
    geom.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    if (orbitMesh) orbitMesh.geometry = geom;
    // Update current planet position and orbital speed
    orbitSpeed = 0.02 / Math.sqrt(orbitRadius);
    planetMesh.position.set(Math.cos(orbitAngle) * orbitRadius, 0, Math.sin(orbitAngle) * orbitRadius);
}

function animate() {
    requestAnimationFrame(animate);
    // Advance orbit
    orbitAngle += orbitSpeed;
    if (planetMesh) {
        const r = Math.max(currentOrbitRadius, 0.5);
        planetMesh.position.set(Math.cos(orbitAngle) * r, 0, Math.sin(orbitAngle) * r);
        planetMesh.rotation.y += 0.01; // spin
    }
    if (controls && controls.update) {
        controls.update();
    } else if (camera) {
        // Auto-rotate fallback around the origin at fixed radius to avoid zoom drift
        const t = performance.now() * 0.0001;
        const radius = 10; // fixed
        const y = 4; // fixed elevation
        camera.position.set(Math.cos(t) * radius, y, Math.sin(t) * radius);
        camera.lookAt(0, 0, 0);
    }
    if (renderer && scene && camera) renderer.render(scene, camera);
}

// Initialize 3D after page load
document.addEventListener('DOMContentLoaded', function() {
    try {
        // WebGL support guard
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) {
            console.warn('WebGL not supported; 3D visualization disabled');
            return;
        }
        init3D();
        update3DFromForm();
        if (!isAnimating) { isAnimating = true; animate(); }
    } catch (e) { console.warn('3D init error:', e); }
});
</script>
{% endblock %}
