{% extends "base.html" %}

{% block title %}ðŸ§  Explainable AI - ExoplanetML{% endblock %}

{% block content %}
<div class="container-fluid py-5 mt-5">
    <!-- Explainability Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-info">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-brain me-2"></i>
                        Explainable AI System
                    </h4>
                    <p class="mb-0 mt-2">Advanced model interpretability using SHAP, LIME, and feature importance analysis</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Explainability Interface -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card bg-dark border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-search me-2"></i>
                        Model Explanation Input
                    </h5>
                </div>
                <div class="card-body">
                    <form id="explainabilityForm">
                        <div class="mb-3">
                            <label for="expPeriod" class="form-label">
                                <i class="fas fa-clock me-1"></i>Orbital Period (days)
                            </label>
                            <input type="number" class="form-control" id="expPeriod" 
                                   value="365.25" min="0.1" max="10000" step="0.1">
                        </div>

                        <div class="mb-3">
                            <label for="expRadius" class="form-label">
                                <i class="fas fa-globe me-1"></i>Planet Radius (Earth radii)
                            </label>
                            <input type="number" class="form-control" id="expRadius" 
                                   value="1.0" min="0.1" max="50" step="0.1">
                        </div>

                        <div class="mb-3">
                            <label for="expStellarTemp" class="form-label">
                                <i class="fas fa-sun me-1"></i>Stellar Temperature (K)
                            </label>
                            <input type="number" class="form-control" id="expStellarTemp" 
                                   value="5800" min="2000" max="10000" step="100">
                        </div>

                        <div class="mb-3">
                            <label for="expStellarRadius" class="form-label">
                                <i class="fas fa-circle me-1"></i>Stellar Radius (Solar radii)
                            </label>
                            <input type="number" class="form-control" id="expStellarRadius" 
                                   value="1.0" min="0.1" max="100" step="0.1">
                        </div>

                        <div class="mb-3">
                            <label for="expDepth" class="form-label">
                                <i class="fas fa-chart-line me-1"></i>Transit Depth
                            </label>
                            <input type="number" class="form-control" id="expDepth" 
                                   value="0.01" min="0.001" max="1" step="0.001">
                        </div>

                        <div class="mb-3">
                            <label for="explanationType" class="form-label">
                                <i class="fas fa-cogs me-1"></i>Explanation Type
                            </label>
                            <select class="form-select" id="explanationType">
                                <option value="shap">SHAP Values</option>
                                <option value="lime">LIME Explanations</option>
                                <option value="both">Both SHAP & LIME</option>
                            </select>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-info btn-lg">
                                <i class="fas fa-brain me-2"></i>Generate Explanation
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <!-- Explanation Results -->
            <div id="explanationResults" class="card bg-dark border-info" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Model Explanation Results
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-info" id="explanationPrediction">-</h4>
                                <p class="mb-0">Prediction</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-success" id="explanationConfidence">-</h4>
                                <p class="mb-0">Confidence</p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-primary">Feature Importance</h6>
                            <div id="featureImportanceList" class="bg-dark text-light p-3 rounded">
                                <!-- Feature importance will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Explanation Methods -->
            <div class="card bg-dark border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Explanation Methods
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <h6 class="text-primary">SHAP Values</h6>
                            <ul class="list-unstyled small text-muted">
                                <li>â€¢ Global feature importance</li>
                                <li>â€¢ Local explanations</li>
                                <li>â€¢ Model-agnostic</li>
                                <li>â€¢ Additive feature attributions</li>
                            </ul>
                        </div>
                        <div class="col-6">
                            <h6 class="text-primary">LIME</h6>
                            <ul class="list-unstyled small text-muted">
                                <li>â€¢ Local interpretable explanations</li>
                                <li>â€¢ Linear approximations</li>
                                <li>â€¢ Perturbation-based</li>
                                <li>â€¢ Human-readable</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Explanation Visualization -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Feature Importance Visualization
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <canvas id="featureImportanceChart" height="300"></canvas>
                        </div>
                        <div class="col-lg-4">
                            <h6 class="text-primary">Explanation Summary</h6>
                            <div id="explanationSummary" class="bg-dark text-light p-3 rounded">
                                <p class="mb-1"><strong>Top Feature:</strong> <span id="topFeature">-</span></p>
                                <p class="mb-1"><strong>Contribution:</strong> <span id="topContribution">-</span></p>
                                <p class="mb-1"><strong>Model Used:</strong> <span id="modelUsed">-</span></p>
                                <p class="mb-0"><strong>Explanation Type:</strong> <span id="expType">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SHAP vs LIME Comparison -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-balance-scale me-2"></i>
                        SHAP vs LIME Comparison
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <h6 class="text-primary">SHAP Values</h6>
                            <canvas id="shapChart" height="200"></canvas>
                        </div>
                        <div class="col-lg-6">
                            <h6 class="text-primary">LIME Explanations</h6>
                            <canvas id="limeChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Interpretability -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-eye me-2"></i>
                        Model Interpretability
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="text-primary">Global Interpretability</h6>
                            <p class="text-muted small">
                                Understanding how the model makes decisions across all inputs. 
                                Shows which features are most important overall.
                            </p>
                            <ul class="list-unstyled small text-muted">
                                <li>â€¢ Feature importance rankings</li>
                                <li>â€¢ Model behavior patterns</li>
                                <li>â€¢ Bias detection</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-primary">Local Interpretability</h6>
                            <p class="text-muted small">
                                Understanding why the model made a specific prediction for 
                                a particular input. Explains individual decisions.
                            </p>
                            <ul class="list-unstyled small text-muted">
                                <li>â€¢ Individual predictions</li>
                                <li>â€¢ Feature contributions</li>
                                <li>â€¢ Decision rationale</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-primary">Counterfactual Analysis</h6>
                            <p class="text-muted small">
                                Understanding what changes to inputs would lead to 
                                different predictions. "What if" scenarios.
                            </p>
                            <ul class="list-unstyled small text-muted">
                                <li>â€¢ Sensitivity analysis</li>
                                <li>â€¢ Alternative scenarios</li>
                                <li>â€¢ Decision boundaries</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Explanation Examples -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Explanation Examples
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>Scenario</th>
                                    <th>Prediction</th>
                                    <th>Key Features</th>
                                    <th>Explanation</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Earth-like Planet</strong></td>
                                    <td><span class="badge bg-success">Confirmed</span></td>
                                    <td>Radius: 1.0, Period: 365 days</td>
                                    <td>Size and orbital period within habitable range</td>
                                    <td>89%</td>
                                </tr>
                                <tr>
                                    <td><strong>Gas Giant</strong></td>
                                    <td><span class="badge bg-warning">Candidate</span></td>
                                    <td>Radius: 12.0, Depth: 0.15</td>
                                    <td>Large radius suggests gas giant, deep transit</td>
                                    <td>72%</td>
                                </tr>
                                <tr>
                                    <td><strong>False Positive</strong></td>
                                    <td><span class="badge bg-danger">False Positive</span></td>
                                    <td>SNR: 3.2, Duration: 0.02</td>
                                    <td>Low signal-to-noise ratio, short duration</td>
                                    <td>85%</td>
                                </tr>
                                <tr>
                                    <td><strong>Hot Jupiter</strong></td>
                                    <td><span class="badge bg-success">Confirmed</span></td>
                                    <td>Period: 3.2 days, Radius: 8.5</td>
                                    <td>Short period, large radius typical of hot Jupiter</td>
                                    <td>94%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById('explainabilityForm').addEventListener('submit', function(e) {
    e.preventDefault();
    generateExplanation();
});

function generateExplanation() {
    const formData = {
        period: parseFloat(document.getElementById('expPeriod').value),
        planet_radius: parseFloat(document.getElementById('expRadius').value),
        stellar_temp: parseFloat(document.getElementById('expStellarTemp').value),
        stellar_radius: parseFloat(document.getElementById('expStellarRadius').value),
        transit_depth: parseFloat(document.getElementById('expDepth').value),
        explanation_type: document.getElementById('explanationType').value
    };

    fetch('/api/explainability', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        displayExplanationResults(data);
    })
    .catch(error => {
        console.error('Error generating explanation:', error);
        // Use mock data for demonstration
        displayExplanationResults(getMockExplanationData(formData));
    });
}

function displayExplanationResults(explanation) {
    document.getElementById('explanationResults').style.display = 'block';
    
    // Update prediction and confidence
    document.getElementById('explanationPrediction').textContent = explanation.prediction || 'confirmed';
    document.getElementById('explanationConfidence').textContent = 
        ((explanation.confidence || 0.85) * 100).toFixed(1) + '%';
    
    // Update feature importance
    updateFeatureImportance(explanation.feature_importance || {});
    
    // Update visualizations
    updateFeatureImportanceChart(explanation.feature_importance || {});
    updateSHAPChart(explanation.shap_values || {});
    updateLIMEChart(explanation.lime_values || {});
    
    // Update summary
    updateExplanationSummary(explanation);
}

function updateFeatureImportance(featureImportance) {
    const importanceList = document.getElementById('featureImportanceList');
    let html = '';
    
    const features = Object.entries(featureImportance)
        .sort(([,a], [,b]) => Math.abs(b) - Math.abs(a))
        .slice(0, 5);
    
    features.forEach(([feature, importance]) => {
        const importanceClass = importance > 0 ? 'text-success' : 'text-danger';
        const icon = importance > 0 ? 'fa-arrow-up' : 'fa-arrow-down';
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span><i class="fas ${icon} me-2"></i>${feature.replace('_', ' ').toUpperCase()}</span>
                <span class="${importanceClass}">${importance.toFixed(3)}</span>
            </div>
        `;
    });
    
    importanceList.innerHTML = html;
}

function updateFeatureImportanceChart(featureImportance) {
    const ctx = document.getElementById('featureImportanceChart').getContext('2d');
    
    if (window.featureImportanceChart) {
        window.featureImportanceChart.destroy();
    }
    
    const features = Object.keys(featureImportance);
    const values = Object.values(featureImportance);
    
    window.featureImportanceChart = new Chart(ctx, {
        type: 'horizontalBar',
        data: {
            labels: features.map(f => f.replace('_', ' ').toUpperCase()),
            datasets: [{
                label: 'Feature Importance',
                data: values,
                backgroundColor: values.map(v => v > 0 ? '#28a745' : '#dc3545'),
                borderWidth: 1,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: {
                    ticks: {
                        color: '#ffffff'
                    }
                },
                y: {
                    ticks: {
                        color: '#ffffff'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateSHAPChart(shapValues) {
    const ctx = document.getElementById('shapChart').getContext('2d');
    
    if (window.shapChart) {
        window.shapChart.destroy();
    }
    
    // Mock SHAP values if not provided
    const features = ['Planet Radius', 'Stellar Temp', 'Orbital Period', 'Transit Depth', 'Stellar Radius'];
    const values = shapValues.values || [0.25, 0.20, 0.18, 0.15, 0.12];
    
    window.shapChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: features,
            datasets: [{
                label: 'SHAP Values',
                data: values,
                backgroundColor: '#17a2b8',
                borderWidth: 1,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    ticks: {
                        color: '#ffffff'
                    }
                },
                x: {
                    ticks: {
                        color: '#ffffff'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateLIMEChart(limeValues) {
    const ctx = document.getElementById('limeChart').getContext('2d');
    
    if (window.limeChart) {
        window.limeChart.destroy();
    }
    
    // Mock LIME values if not provided
    const features = ['Planet Radius', 'Stellar Temp', 'Orbital Period', 'Transit Depth', 'Stellar Radius'];
    const values = limeValues.values || [0.22, 0.18, 0.16, 0.14, 0.10];
    
    window.limeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: features,
            datasets: [{
                label: 'LIME Values',
                data: values,
                backgroundColor: '#ffc107',
                borderWidth: 1,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    ticks: {
                        color: '#ffffff'
                    }
                },
                x: {
                    ticks: {
                        color: '#ffffff'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateExplanationSummary(explanation) {
    const featureImportance = explanation.feature_importance || {};
    const topFeature = Object.entries(featureImportance)
        .sort(([,a], [,b]) => Math.abs(b) - Math.abs(a))[0];
    
    document.getElementById('topFeature').textContent = topFeature ? topFeature[0].replace('_', ' ') : 'N/A';
    document.getElementById('topContribution').textContent = topFeature ? topFeature[1].toFixed(3) : 'N/A';
    document.getElementById('modelUsed').textContent = explanation.model_used || 'XGBoost';
    document.getElementById('expType').textContent = document.getElementById('explanationType').value.toUpperCase();
}

function getMockExplanationData(formData) {
    // Generate mock explanation data
    const features = {
        'planet_radius': formData.planet_radius,
        'stellar_temp': formData.stellar_temp,
        'period': formData.period,
        'transit_depth': formData.transit_depth,
        'stellar_radius': formData.stellar_radius
    };
    
    // Calculate mock feature importance based on input values
    const featureImportance = {};
    Object.entries(features).forEach(([key, value]) => {
        // Simple heuristic for feature importance
        let importance = 0;
        if (key === 'planet_radius') {
            importance = Math.abs(value - 1.0) * 0.5; // Closer to Earth size = higher importance
        } else if (key === 'stellar_temp') {
            importance = Math.abs(value - 5800) / 1000 * 0.3; // Closer to Sun temp = higher importance
        } else if (key === 'period') {
            importance = Math.abs(value - 365.25) / 365.25 * 0.2; // Closer to Earth period = higher importance
        } else if (key === 'transit_depth') {
            importance = value * 10; // Deeper transit = higher importance
        } else if (key === 'stellar_radius') {
            importance = Math.abs(value - 1.0) * 0.4; // Closer to Sun radius = higher importance
        }
        
        featureImportance[key] = importance;
    });
    
    // Normalize importance values
    const maxImportance = Math.max(...Object.values(featureImportance));
    Object.keys(featureImportance).forEach(key => {
        featureImportance[key] = featureImportance[key] / maxImportance;
    });
    
    return {
        prediction: 'confirmed',
        confidence: 0.85,
        feature_importance: featureImportance,
        shap_values: {
            values: Object.values(featureImportance)
        },
        lime_values: {
            values: Object.values(featureImportance).map(v => v * 0.9) // Slightly different for comparison
        },
        model_used: 'XGBoost'
    };
}
</script>
{% endblock %}
